<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SNSæ€ªè«‡ãƒ»4è¦ç´ ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆå¤–éƒ¨JSONåˆ†é›¢ç‰ˆï¼‰</title>
    <style>
        :root {
            --bg: #0b0c10;
            --panel: #141621;
            --text: #e8e9ef;
            --muted: #a7acbd;
            --line: #2a2f44;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
            background: radial-gradient(1200px 600px at 10% 0%, #121633 0%, var(--bg) 55%);
            color: var(--text);
        }

        h1 {
            margin: 0 0 10px;
            font-size: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1.1fr .9fr;
            gap: 14px;
            align-items: start;
        }

        @media (max-width: 980px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(20, 22, 33, .92);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 14px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, .25);
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .row>* {
            flex: 1;
            min-width: 160px;
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin: 0 0 6px;
        }

        textarea,
        input,
        select {
            width: 100%;
            background: #0f1120;
            color: var(--text);
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 10px;
            outline: none;
        }

        textarea {
            min-height: 220px;
            resize: vertical;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Noto Sans Mono", monospace;
        }

        button {
            background: #2b61ff;
            color: white;
            border: 0;
            border-radius: 12px;
            padding: 10px 12px;
            cursor: pointer;
            font-weight: 600;
        }

        button.secondary {
            background: #22263a;
            border: 1px solid var(--line);
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        .help {
            color: var(--muted);
            font-size: 12px;
            line-height: 1.5;
            margin-top: 8px;
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .item {
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 12px;
            background: #0f1120;
        }

        .meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            color: var(--muted);
            font-size: 12px;
        }

        .text {
            margin: 8px 0 10px;
            line-height: 1.6;
        }

        .scores {
            display: grid;
            grid-template-columns: 120px 1fr 60px;
            gap: 8px;
            align-items: center;
            font-size: 12px;
            margin-top: 8px;
        }

        .bar {
            height: 10px;
            background: #161a2e;
            border: 1px solid var(--line);
            border-radius: 999px;
            overflow: hidden;
        }

        .fill {
            height: 100%;
            background: linear-gradient(90deg, #2b61ff, #7c4dff);
            width: 0%;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: #10122a;
            color: var(--muted);
            font-size: 12px;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Noto Sans Mono", monospace;
        }

        .hr {
            height: 1px;
            background: var(--line);
            margin: 12px 0;
        }

        .small {
            font-size: 12px;
            color: var(--muted);
        }

        .danger {
            color: #ffb4b4;
        }

        .ok {
            color: #b8ffcc;
        }

        .path {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Noto Sans Mono", monospace;
        }
    </style>
</head>

<body>
    <h1>SNSæ€ªè«‡ãƒ»4è¦ç´ ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆå¤–éƒ¨JSONåˆ†é›¢ç‰ˆï¼‰</h1>

    <div class="grid">
        <div class="card">
            <div class="row">
                <div>
                    <label>å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«</label>
                    <div class="small">
                        æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿: <span class="path">data.json</span><br>
                        èªå½™è¾æ›¸: <span class="path">lex.json</span><br>
                        åª’ä½“ãƒ¢ãƒ‡ãƒ«: <span class="path">platforms.json</span>
                    </div>
                </div>
                <div>
                    <label>ã‚¹ã‚³ã‚¢æ„Ÿåº¦ï¼ˆ0.5ã€œ2.0ï¼‰</label>
                    <input id="gain" type="number" min="0.5" max="2.0" step="0.1" value="1.0" />
                </div>
            </div>

            <div class="hr"></div>

            <label>èª­ã¿è¾¼ã‚“ã  data.jsonï¼ˆç¢ºèªç”¨ï¼‰</label>
            <textarea id="dataPreview" readonly></textarea>

            <div class="row" style="margin-top:12px;">
                <button id="btnReload">å¤–éƒ¨JSONã‚’å†èª­ã¿è¾¼ã¿</button>
                <button id="btnExport" class="secondary" disabled>è§£æçµæœJSONã‚’æ›¸ãå‡ºã™</button>
            </div>

            <div class="help">
                ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ãå ´åˆã¯HTTPã‚µãƒ¼ãƒãƒ¼çµŒç”±ã«ã—ã¦ãã ã•ã„ã€‚ä¾‹: <span class="path">python -m http.server 8000</span>ã€‚<span
                    class="path">file:///</span> ç›´é–‹ãã ã¨ fetch ãŒæ­¢ã¾ã‚Šã¾ã™ã€‚
            </div>
        </div>

        <div class="card">
            <div class="row">
                <div>
                    <label>è¡¨ç¤º</label>
                    <select id="sort">
                        <option value="time">æŠ•ç¨¿æ™‚åˆ»ï¼ˆæ–°ã—ã„é †ï¼‰</option>
                        <option value="buzz">ãƒã‚ºæ¨å®šï¼ˆé«˜ã„é †ï¼‰</option>
                        <option value="real">å®Ÿè©±æ€§ï¼ˆé«˜ã„é †ï¼‰</option>
                        <option value="anon">åŒ¿åæ€§ï¼ˆé«˜ã„é †ï¼‰</option>
                        <option value="empa">å…±æ„Ÿæ€§ï¼ˆé«˜ã„é †ï¼‰</option>
                        <option value="part">å‚åŠ æ€§ï¼ˆé«˜ã„é †ï¼‰</option>
                    </select>
                </div>
                <div>
                    <label>ã—ãã„å€¤ï¼ˆãƒã‚ºæ¨å®šï¼‰</label>
                    <input id="buzzTh" type="number" min="0" max="1" step="0.05" value="0.55" />
                </div>
            </div>

            <div class="hr"></div>
            <div id="summary" class="small">æœªèª­ã¿è¾¼ã¿</div>
            <div class="hr"></div>
            <div id="results" class="list"></div>
        </div>
    </div>

    <script>
        /*
          å¤–éƒ¨JSONåˆ†é›¢ã®æ§‹æˆ
          - data.json: æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ï¼ˆé…åˆ—ï¼‰
          - lex.json: 4è¦ç´ ã®èªå½™è¾æ›¸ï¼ˆreal/anon/empa/partï¼‰
          - platforms.json: åª’ä½“ãƒ¢ãƒ‡ãƒ«ï¼ˆåª’ä½“ã”ã¨ã®é‡ã¿ã¨èª¬æ˜ï¼‰
        */

        const $ = (id) => document.getElementById(id);

        let LEX = null;
        let PLATFORMS = null;
        let lastAnalyzed = [];

        function clamp01(x) { return Math.max(0, Math.min(1, x)); }
        function nowIso() { return new Date().toISOString(); }

        function normalizeText(s) {
            return (s ?? "")
                .toString()
                .replace(/\r\n/g, "\n")
                .replace(/\r/g, "\n")
                .replace(/\t/g, " ")
                .trim();
        }

        function toSafeTextAsHtml(s) {
            return (s ?? "").toString()
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replace(/\r\n|\r|\n/g, "<br>");
        }

        function countHits(text, words) {
            const hits = [];
            for (const w of words) {
                if (!w) continue;
                if (text.includes(w)) hits.push(w);
            }
            return hits;
        }

        function scoreByLex(text, blocks, gain) {
            let score = 0;
            const evidence = [];
            for (const b of blocks) {
                const hits = countHits(text, b.w);
                if (hits.length) {
                    const add = b.p * Math.min(3, hits.length);
                    score += add;
                    evidence.push({ hits, add });
                }
            }
            const len = text.length;
            const lenFactor = len < 40 ? 0.75 : (len < 120 ? 0.90 : 1.00);
            score = score * gain * lenFactor;
            return { score: clamp01(score), evidence };
        }

        function flattenEvidence(evs) {
            const words = [];
            for (const e of evs) {
                for (const h of e.hits) words.push(h);
            }
            return [...new Set(words)].slice(0, 10);
        }

        function engagementScore({ likes = 0, shares = 0, comments = 0 }) {
            const l = Math.max(0, Number(likes) || 0);
            const s = Math.max(0, Number(shares) || 0);
            const c = Math.max(0, Number(comments) || 0);
            const v = Math.log10(1 + l) * 0.55 + Math.log10(1 + s) * 0.90 + Math.log10(1 + c) * 0.70;
            return clamp01(v / 3.5);
        }

        function anonymizeScoreBoost(author) {
            const a = (author ?? "").toString().trim();
            if (!a) return 0.10;
            if (a === "åŒ¿å") return 0.18;
            if (a.includes("anon") || a.includes("åŒ¿å")) return 0.12;
            return 0.0;
        }

        function fmt01(x) { return (Math.round(x * 100) / 100).toFixed(2); }
        function fmtPct(x) { return `${Math.round(x * 100)}%`; }

        function avg(posts, key) {
            if (!posts.length) return 0;
            let s = 0;
            for (const p of posts) s += Number(p.scores[key] || 0);
            return s / posts.length;
        }

        function getPlatformModel(platformName) {
            if (!PLATFORMS) return { engagementWeight: 0.30, fourFactorWeight: 0.70, description: "æœªèª­ã¿è¾¼ã¿" };
            return PLATFORMS[platformName] || PLATFORMS["default"] || { engagementWeight: 0.30, fourFactorWeight: 0.70, description: "æœªå®šç¾©åª’ä½“" };
        }

        function analyzePost(post, gain) {
            if (!LEX) {
                throw new Error("lex.json ãŒæœªèª­ã¿è¾¼ã¿ã§ã™ã€‚");
            }

            const text = normalizeText(post.text);
            const r = scoreByLex(text, LEX.real || [], gain);
            const a = scoreByLex(text, LEX.anon || [], gain);
            const e = scoreByLex(text, LEX.empa || [], gain);
            const p = scoreByLex(text, LEX.part || [], gain);

            const anonBoost = anonymizeScoreBoost(post.author);
            const anon = clamp01(a.score + anonBoost);
            const eng = engagementScore(post);

            const platformModel = getPlatformModel(post.platform);
            const fourMean = (r.score + anon + e.score + p.score) / 4;

            const buzz = clamp01(
                fourMean * Number(platformModel.fourFactorWeight ?? 0.70) +
                eng * Number(platformModel.engagementWeight ?? 0.30)
            );

            const ev = {
                real: flattenEvidence(r.evidence),
                anon: flattenEvidence(a.evidence),
                empa: flattenEvidence(e.evidence),
                part: flattenEvidence(p.evidence),
                anonBoost: anonBoost ? `ä½œè€…è£œæ­£ +${anonBoost.toFixed(2)}` : ""
            };

            return {
                ...post,
                text,
                scores: { real: r.score, anon, empa: e.score, part: p.score, eng, buzz },
                evidence: ev,
                platformModel
            };
        }

        function scoreRow(label, val, evidenceArr) {
            const ev = (evidenceArr && evidenceArr.length)
                ? `æ ¹æ‹ : ${evidenceArr.map(x => `ã€Œ${toSafeTextAsHtml(x)}ã€`).join("ã€")}`
                : "æ ¹æ‹ : ï¼ˆãƒ’ãƒƒãƒˆèªå½™ãªã—ï¼‰";
            return `
    <div class="scores">
      <div>${label}</div>
      <div class="bar"><div class="fill" data-fill="${val}"></div></div>
      <div class="mono">${fmtPct(val)}</div>
      <div class="small" style="grid-column: 1 / -1; margin:-2px 0 6px;">${ev}</div>
    </div>
  `;
        }

        function render(posts) {
            const th = clamp01(Number($("buzzTh").value) || 0);
            const sortMode = $("sort").value;

            const sorted = [...posts].sort((a, b) => {
                const sa = a.scores, sb = b.scores;
                const ta = Date.parse(a.postedAt || "") || 0;
                const tb = Date.parse(b.postedAt || "") || 0;
                if (sortMode === "time") return tb - ta;
                if (sortMode === "buzz") return sb.buzz - sa.buzz;
                if (sortMode === "real") return sb.real - sa.real;
                if (sortMode === "anon") return sb.anon - sa.anon;
                if (sortMode === "empa") return sb.empa - sa.empa;
                if (sortMode === "part") return sb.part - sa.part;
                return 0;
            });

            const flagged = sorted.filter(p => p.scores.buzz >= th);
            const summary =
                `è§£æä»¶æ•° ${posts.length} ä»¶ãƒ»ã—ãã„å€¤ä»¥ä¸Š ${flagged.length} ä»¶ã€‚å¹³å‡ï¼ˆå®Ÿè©±æ€§ ${fmt01(avg(posts, "real"))}ï¼åŒ¿åæ€§ ${fmt01(avg(posts, "anon"))}ï¼å…±æ„Ÿæ€§ ${fmt01(avg(posts, "empa"))}ï¼å‚åŠ æ€§ ${fmt01(avg(posts, "part"))}ï¼ãƒã‚ºæ¨å®š ${fmt01(avg(posts, "buzz"))}ï¼‰`;
            $("summary").innerHTML = `<span class="ok">èª­ã¿è¾¼ã¿å®Œäº†ã€‚</span> ${summary}`;

            const root = $("results");
            root.innerHTML = "";

            for (const p of sorted) {
                const s = p.scores;
                const isHot = s.buzz >= th;
                const ev = p.evidence;
                const pm = p.platformModel || getPlatformModel(p.platform);

                const posted = p.postedAt ? new Date(p.postedAt).toLocaleString("ja-JP") : "ä¸æ˜";
                const el = document.createElement("div");
                el.className = "item";
                el.innerHTML = `
      <div class="meta">
        <span class="tag">åª’ä½“: <span class="mono">${toSafeTextAsHtml(p.platform || "ä¸æ˜")}</span></span>
        <span class="tag">åª’ä½“ç‰¹æ€§: <span class="mono">${toSafeTextAsHtml(pm.description || "")}</span></span>
        <span class="tag">ID: <span class="mono">${toSafeTextAsHtml(p.id || "no-id")}</span></span>
        <span class="tag">ä½œè€…: <span class="mono">${toSafeTextAsHtml(p.author || "ä¸æ˜")}</span></span>
        <span class="tag">æŠ•ç¨¿: <span class="mono">${toSafeTextAsHtml(posted)}</span></span>
        <span class="tag">åå¿œ: <span class="mono">â¤${Number(p.likes || 0)} â†»${Number(p.shares || 0)} ğŸ’¬${Number(p.comments || 0)}</span></span>
        <span class="tag">ãƒã‚ºæ¨å®š: <span class="mono">${fmtPct(s.buzz)}</span></span>
      </div>

      <div class="text">${toSafeTextAsHtml(p.text)}</div>

      ${scoreRow("å®Ÿè©±æ€§", s.real, ev.real)}
      ${scoreRow("åŒ¿åæ€§", s.anon, [...ev.anon, ev.anonBoost].filter(Boolean))}
      ${scoreRow("å…±æ„Ÿæ€§", s.empa, ev.empa)}
      ${scoreRow("å‚åŠ æ€§", s.part, ev.part)}
      ${scoreRow("åå¿œé‡", s.eng, ["ã„ã„ã­/ã‚·ã‚§ã‚¢/ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¯¾æ•°åœ§ç¸®"])}

      <div class="small">
        ${isHot ? "ã—ãã„å€¤ä»¥ä¸Šã€‚å¾ªç’°ãŒå›ã‚Šãã†ãªå€‹ä½“ã€‚" : "ã—ãã„å€¤æœªæº€ã€‚ä¼¸ã³ãªã„ç†ç”±ã®ä»®èª¬ã‚’ä½œã‚‹ææ–™ã€‚"}
        é‡ã¿ï¼ˆ4è¦ç´  ${Number(pm.fourFactorWeight ?? 0.70).toFixed(2)}ãƒ»åå¿œ ${Number(pm.engagementWeight ?? 0.30).toFixed(2)}ï¼‰ã€‚
      </div>
    `;

                for (const bar of el.querySelectorAll("[data-fill]")) {
                    const v = Number(bar.getAttribute("data-fill"));
                    bar.style.width = `${Math.round(v * 100)}%`;
                }
                root.appendChild(el);
            }
        }

        function normalizePost(p, i) {
            return {
                id: p.id ?? `p${i + 1}`,
                platform: p.platform ?? "ä¸æ˜",
                author: p.author ?? "ä¸æ˜",
                postedAt: p.postedAt ?? nowIso(),
                likes: p.likes ?? 0,
                shares: p.shares ?? 0,
                comments: p.comments ?? 0,
                text: p.text ?? ""
            };
        }

        async function loadJsonFile(path) {
            const res = await fetch(path, { cache: "no-store" });
            if (!res.ok) {
                throw new Error(`${path} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ${res.status}ï¼‰ã€‚`);
            }
            return await res.json();
        }

        async function loadAllAndAnalyze() {
            $("summary").innerHTML = "èª­ã¿è¾¼ã¿ä¸­ã€‚";
            $("btnExport").disabled = true;

            const gain = Number($("gain").value) || 1.0;

            try {
                LEX = await loadJsonFile("lex.json");
                PLATFORMS = await loadJsonFile("platforms.json");
                const data = await loadJsonFile("data.json");

                const posts = (Array.isArray(data) ? data : [data]).map(normalizePost);

                $("dataPreview").value = JSON.stringify(posts, null, 2);

                lastAnalyzed = posts.map(p => analyzePost(p, gain));
                $("btnExport").disabled = lastAnalyzed.length === 0;

                render(lastAnalyzed);
            } catch (err) {
                $("summary").innerHTML = `<span class="danger">${toSafeTextAsHtml(err.message || String(err))}</span>`;
                $("results").innerHTML = "";
                $("dataPreview").value = "";
                lastAnalyzed = [];
            }
        }

        function exportJson() {
            if (!lastAnalyzed.length) return;
            const blob = new Blob([JSON.stringify(lastAnalyzed, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "kaidan_4factor_result.json";
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }

        $("btnReload").addEventListener("click", loadAllAndAnalyze);
        $("btnExport").addEventListener("click", exportJson);
        $("sort").addEventListener("change", () => render(lastAnalyzed));
        $("buzzTh").addEventListener("input", () => render(lastAnalyzed));
        $("gain").addEventListener("change", () => loadAllAndAnalyze());

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        loadAllAndAnalyze();
    </script>
</body>

</html>