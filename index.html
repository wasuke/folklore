<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SNSæ€ªè«‡ãƒ»4è¦ç´ ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆå¤–éƒ¨JSONç·¨é›†UIã¤ãï¼‰</title>
  <style>
    :root { --bg:#0b0c10; --panel:#141621; --text:#e8e9ef; --muted:#a7acbd; --line:#2a2f44; }
    * { box-sizing:border-box; }
    body{
      margin:0; padding:20px;
      font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 600px at 10% 0%, #121633 0%, var(--bg) 55%);
      color:var(--text);
    }
    h1{ margin:0 0 10px; font-size:20px; }
    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; align-items:start; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    .card{
      background: rgba(20,22,33,.92);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:180px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    textarea, input, select{
      width:100%;
      background:#0f1120;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      outline:none;
    }
    textarea{
      resize:vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Noto Sans Mono", monospace;
      line-height:1.5;
    }
    button{
      background:#2b61ff;
      color:white;
      border:0;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:600;
    }
    button.secondary{ background:#22263a; border:1px solid var(--line); }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .help{ color:var(--muted); font-size:12px; line-height:1.5; margin-top:8px; }
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      background:#0f1120;
    }
    .meta{ display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:12px; }
    .text{ margin:8px 0 10px; line-height:1.6; }
    .scores{
      display:grid;
      grid-template-columns: 120px 1fr 60px;
      gap:8px;
      align-items:center;
      font-size:12px;
      margin-top:8px;
    }
    .bar{
      height:10px;
      background:#161a2e;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
    }
    .fill{ height:100%; background: linear-gradient(90deg, #2b61ff, #7c4dff); width:0%; }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      border:1px solid var(--line); background:#10122a;
      color:var(--muted); font-size:12px;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Noto Sans Mono", monospace; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    .small{ font-size:12px; color:var(--muted); }
    .danger{ color:#ffb4b4; }
    .ok{ color:#b8ffcc; }
    .path{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Noto Sans Mono", monospace; }

    details{
      border:1px solid var(--line);
      border-radius:12px;
      background:#0f1120;
      padding:10px 10px 12px;
      margin:10px 0;
    }
    summary{
      cursor:pointer;
      color:var(--text);
      font-weight:700;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .jsonbox{ margin-top:10px; }
    .jsonbox textarea{ min-height:180px; }
    .jsonhint{ margin-top:6px; }
  </style>
</head>
<body>
  <h1>SNSæ€ªè«‡ãƒ»4è¦ç´ ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆå¤–éƒ¨JSONç·¨é›†UIã¤ãï¼‰</h1>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div>
          <label>å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«</label>
          <div class="small">
            æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿: <span class="path">data.json</span><br>
            èªå½™è¾æ›¸: <span class="path">lex.json</span><br>
            åª’ä½“ãƒ¢ãƒ‡ãƒ«: <span class="path">platforms.json</span>
          </div>
        </div>
        <div>
          <label>ã‚¹ã‚³ã‚¢æ„Ÿåº¦ï¼ˆ0.5ã€œ2.0ï¼‰</label>
          <input id="gain" type="number" min="0.5" max="2.0" step="0.1" value="1.0" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button id="btnReload">å¤–éƒ¨JSONã‚’å†èª­ã¿è¾¼ã¿</button>
        <button id="btnRecalc" class="secondary">ãƒ•ã‚©ãƒ¼ãƒ ã®å†…å®¹ã§å†è¨ˆç®—</button>
        <button id="btnExport" class="secondary" disabled>è§£æçµæœJSONã‚’æ›¸ãå‡ºã™</button>
      </div>

      <div class="help">
        ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ãå ´åˆã¯HTTPã‚µãƒ¼ãƒãƒ¼çµŒç”±ã«ã—ã¦ãã ã•ã„ã€‚ä¾‹: <span class="path">python -m http.server 8000</span>ã€‚<span class="path">file:///</span> ç›´é–‹ãã ã¨ fetch ãŒæ­¢ã¾ã‚Šã¾ã™ã€‚
      </div>

      <div class="hr"></div>

      <div class="small">
        ä¸‹ã®3ã¤ã®JSONã¯ãƒ•ã‚©ãƒ¼ãƒ ä¸Šã§ç·¨é›†ã§ãã¾ã™ã€‚<br>
        ç·¨é›†å¾Œã¯ã€Œãƒ•ã‚©ãƒ¼ãƒ ã®å†…å®¹ã§å†è¨ˆç®—ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
      </div>

      <details open>
        <summary>data.jsonï¼ˆæŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ï¼‰</summary>
        <div class="jsonbox">
          <label class="small">å½¢å¼ã¯é…åˆ—ã§ã™ã€‚text ã®æ”¹è¡Œã¯ \\n ã‚’ä½¿ã„ã¾ã™ã€‚</label>
          <textarea id="taData" spellcheck="false"></textarea>
          <div class="small jsonhint">ä¾‹: [{ "id":"p1","platform":"TikTok","author":"åŒ¿å","postedAt":"2026-02-09T09:20:00","likes":10,"shares":1,"comments":2,"text":"â€¦\\nâ€¦" }]</div>
        </div>
      </details>

      <details>
        <summary>lex.jsonï¼ˆèªå½™è¾æ›¸ï¼‰</summary>
        <div class="jsonbox">
          <label class="small">ã‚­ãƒ¼ã¯ real / anon / empa / part ã§ã™ã€‚å„è¦ç´ ã¯ { "w":[...], "p":0.xx } ã®é…åˆ—ã§ã™ã€‚</label>
          <textarea id="taLex" spellcheck="false"></textarea>
        </div>
      </details>

      <details>
        <summary>platforms.jsonï¼ˆåª’ä½“ãƒ¢ãƒ‡ãƒ«ï¼‰</summary>
        <div class="jsonbox">
          <label class="small">å„åª’ä½“ã‚­ãƒ¼ã« { engagementWeight, fourFactorWeight, description } ã‚’ç½®ãã¾ã™ã€‚default ã‚’ç”¨æ„ã—ã¾ã™ã€‚</label>
          <textarea id="taPlatforms" spellcheck="false"></textarea>
        </div>
      </details>

      <div id="leftStatus" class="small">æœªèª­ã¿è¾¼ã¿</div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>è¡¨ç¤º</label>
          <select id="sort">
            <option value="time">æŠ•ç¨¿æ™‚åˆ»ï¼ˆæ–°ã—ã„é †ï¼‰</option>
            <option value="buzz">ãƒã‚ºæ¨å®šï¼ˆé«˜ã„é †ï¼‰</option>
            <option value="real">å®Ÿè©±æ€§ï¼ˆé«˜ã„é †ï¼‰</option>
            <option value="anon">åŒ¿åæ€§ï¼ˆé«˜ã„é †ï¼‰</option>
            <option value="empa">å…±æ„Ÿæ€§ï¼ˆé«˜ã„é †ï¼‰</option>
            <option value="part">å‚åŠ æ€§ï¼ˆé«˜ã„é †ï¼‰</option>
          </select>
        </div>
        <div>
          <label>ã—ãã„å€¤ï¼ˆãƒã‚ºæ¨å®šï¼‰</label>
          <input id="buzzTh" type="number" min="0" max="1" step="0.05" value="0.55" />
        </div>
      </div>

      <div class="hr"></div>
      <div id="summary" class="small">æœªèª­ã¿è¾¼ã¿</div>
      <div class="hr"></div>
      <div id="results" class="list"></div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);

let LEX = null;
let PLATFORMS = null;
let lastAnalyzed = [];

function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function nowIso(){ return new Date().toISOString(); }

function normalizeText(s){
  return (s ?? "")
    .toString()
    .replace(/\r\n/g, "\n")
    .replace(/\r/g, "\n")
    .replace(/\t/g, " ")
    .trim();
}

function toSafeTextAsHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replace(/\r\n|\r|\n/g, "<br>");
}

function countHits(text, words){
  const hits = [];
  for(const w of words){
    if(!w) continue;
    if(text.includes(w)) hits.push(w);
  }
  return hits;
}

function scoreByLex(text, blocks, gain){
  let score = 0;
  const evidence = [];
  for(const b of blocks){
    const hits = countHits(text, b.w);
    if(hits.length){
      const add = b.p * Math.min(3, hits.length);
      score += add;
      evidence.push({hits, add});
    }
  }
  const len = text.length;
  const lenFactor = len < 40 ? 0.75 : (len < 120 ? 0.90 : 1.00);
  score = score * gain * lenFactor;
  return { score: clamp01(score), evidence };
}

function flattenEvidence(evs){
  const words = [];
  for(const e of evs){
    for(const h of e.hits) words.push(h);
  }
  return [...new Set(words)].slice(0, 10);
}

function engagementScore({likes=0, shares=0, comments=0}){
  const l = Math.max(0, Number(likes)||0);
  const s = Math.max(0, Number(shares)||0);
  const c = Math.max(0, Number(comments)||0);
  const v = Math.log10(1 + l) * 0.55 + Math.log10(1 + s) * 0.90 + Math.log10(1 + c) * 0.70;
  return clamp01(v / 3.5);
}

function anonymizeScoreBoost(author){
  const a = (author ?? "").toString().trim();
  if(!a) return 0.10;
  if(a === "åŒ¿å") return 0.18;
  if(a.includes("anon") || a.includes("åŒ¿å")) return 0.12;
  return 0.0;
}

function fmt01(x){ return (Math.round(x*100)/100).toFixed(2); }
function fmtPct(x){ return `${Math.round(x*100)}%`; }

function avg(posts, key){
  if(!posts.length) return 0;
  let s=0;
  for(const p of posts) s += Number(p.scores[key]||0);
  return s / posts.length;
}

function getPlatformModel(platformName){
  if(!PLATFORMS) return {engagementWeight:0.30, fourFactorWeight:0.70, description:"æœªèª­ã¿è¾¼ã¿"};
  return PLATFORMS[platformName] || PLATFORMS["default"] || {engagementWeight:0.30, fourFactorWeight:0.70, description:"æœªå®šç¾©åª’ä½“"};
}

function normalizePost(p, i){
  return {
    id: p.id ?? `p${i+1}`,
    platform: p.platform ?? "ä¸æ˜",
    author: p.author ?? "ä¸æ˜",
    postedAt: p.postedAt ?? nowIso(),
    likes: p.likes ?? 0,
    shares: p.shares ?? 0,
    comments: p.comments ?? 0,
    text: p.text ?? ""
  };
}

function analyzePost(post, gain){
  if(!LEX){
    throw new Error("lex.json ãŒæœªèª­ã¿è¾¼ã¿ã§ã™ã€‚");
  }
  const text = normalizeText(post.text);

  const r = scoreByLex(text, LEX.real || [], gain);
  const a = scoreByLex(text, LEX.anon || [], gain);
  const e = scoreByLex(text, LEX.empa || [], gain);
  const p = scoreByLex(text, LEX.part || [], gain);

  const anonBoost = anonymizeScoreBoost(post.author);
  const anon = clamp01(a.score + anonBoost);
  const eng = engagementScore(post);

  const platformModel = getPlatformModel(post.platform);
  const fourMean = (r.score + anon + e.score + p.score) / 4;

  const buzz = clamp01(
    fourMean * Number(platformModel.fourFactorWeight ?? 0.70) +
    eng * Number(platformModel.engagementWeight ?? 0.30)
  );

  const ev = {
    real: flattenEvidence(r.evidence),
    anon: flattenEvidence(a.evidence),
    empa: flattenEvidence(e.evidence),
    part: flattenEvidence(p.evidence),
    anonBoost: anonBoost ? `ä½œè€…è£œæ­£ +${anonBoost.toFixed(2)}` : ""
  };

  return {
    ...post,
    text,
    scores: { real:r.score, anon, empa:e.score, part:p.score, eng, buzz },
    evidence: ev,
    platformModel
  };
}

function scoreRow(label, val, evidenceArr){
  const ev = (evidenceArr && evidenceArr.length)
    ? `æ ¹æ‹ : ${evidenceArr.map(x=>`ã€Œ${toSafeTextAsHtml(x)}ã€`).join("ã€")}`
    : "æ ¹æ‹ : ï¼ˆãƒ’ãƒƒãƒˆèªå½™ãªã—ï¼‰";
  return `
    <div class="scores">
      <div>${label}</div>
      <div class="bar"><div class="fill" data-fill="${val}"></div></div>
      <div class="mono">${fmtPct(val)}</div>
      <div class="small" style="grid-column: 1 / -1; margin:-2px 0 6px;">${ev}</div>
    </div>
  `;
}

function render(posts){
  const th = clamp01(Number($("buzzTh").value) || 0);
  const sortMode = $("sort").value;

  const sorted = [...posts].sort((a,b)=>{
    const sa = a.scores, sb = b.scores;
    const ta = Date.parse(a.postedAt || "") || 0;
    const tb = Date.parse(b.postedAt || "") || 0;
    if(sortMode==="time") return tb - ta;
    if(sortMode==="buzz") return sb.buzz - sa.buzz;
    if(sortMode==="real") return sb.real - sa.real;
    if(sortMode==="anon") return sb.anon - sa.anon;
    if(sortMode==="empa") return sb.empa - sa.empa;
    if(sortMode==="part") return sb.part - sa.part;
    return 0;
  });

  const flagged = sorted.filter(p => p.scores.buzz >= th);
  const summary =
    `è§£æä»¶æ•° ${posts.length} ä»¶ãƒ»ã—ãã„å€¤ä»¥ä¸Š ${flagged.length} ä»¶ã€‚å¹³å‡ï¼ˆå®Ÿè©±æ€§ ${fmt01(avg(posts,"real"))}ï¼åŒ¿åæ€§ ${fmt01(avg(posts,"anon"))}ï¼å…±æ„Ÿæ€§ ${fmt01(avg(posts,"empa"))}ï¼å‚åŠ æ€§ ${fmt01(avg(posts,"part"))}ï¼ãƒã‚ºæ¨å®š ${fmt01(avg(posts,"buzz"))}ï¼‰`;
  $("summary").innerHTML = `<span class="ok">èª­ã¿è¾¼ã¿å®Œäº†ã€‚</span> ${summary}`;

  const root = $("results");
  root.innerHTML = "";

  for(const p of sorted){
    const s = p.scores;
    const isHot = s.buzz >= th;
    const ev = p.evidence;
    const pm = p.platformModel || getPlatformModel(p.platform);

    const posted = p.postedAt ? new Date(p.postedAt).toLocaleString("ja-JP") : "ä¸æ˜";
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="meta">
        <span class="tag">åª’ä½“: <span class="mono">${toSafeTextAsHtml(p.platform || "ä¸æ˜")}</span></span>
        <span class="tag">åª’ä½“ç‰¹æ€§: <span class="mono">${toSafeTextAsHtml(pm.description || "")}</span></span>
        <span class="tag">ID: <span class="mono">${toSafeTextAsHtml(p.id || "no-id")}</span></span>
        <span class="tag">ä½œè€…: <span class="mono">${toSafeTextAsHtml(p.author || "ä¸æ˜")}</span></span>
        <span class="tag">æŠ•ç¨¿: <span class="mono">${toSafeTextAsHtml(posted)}</span></span>
        <span class="tag">åå¿œ: <span class="mono">â¤${Number(p.likes||0)} â†»${Number(p.shares||0)} ğŸ’¬${Number(p.comments||0)}</span></span>
        <span class="tag">ãƒã‚ºæ¨å®š: <span class="mono">${fmtPct(s.buzz)}</span></span>
      </div>

      <div class="text">${toSafeTextAsHtml(p.text)}</div>

      ${scoreRow("å®Ÿè©±æ€§", s.real, ev.real)}
      ${scoreRow("åŒ¿åæ€§", s.anon, [...ev.anon, ev.anonBoost].filter(Boolean))}
      ${scoreRow("å…±æ„Ÿæ€§", s.empa, ev.empa)}
      ${scoreRow("å‚åŠ æ€§", s.part, ev.part)}
      ${scoreRow("åå¿œé‡", s.eng, ["ã„ã„ã­/ã‚·ã‚§ã‚¢/ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¯¾æ•°åœ§ç¸®"])}

      <div class="small">
        ${isHot ? "ã—ãã„å€¤ä»¥ä¸Šã€‚å¾ªç’°ãŒå›ã‚Šãã†ãªå€‹ä½“ã€‚" : "ã—ãã„å€¤æœªæº€ã€‚ä¼¸ã³ãªã„ç†ç”±ã®ä»®èª¬ã‚’ä½œã‚‹ææ–™ã€‚"}
        é‡ã¿ï¼ˆ4è¦ç´  ${Number(pm.fourFactorWeight ?? 0.70).toFixed(2)}ãƒ»åå¿œ ${Number(pm.engagementWeight ?? 0.30).toFixed(2)}ï¼‰ã€‚
      </div>
    `;

    for(const bar of el.querySelectorAll("[data-fill]")){
      const v = Number(bar.getAttribute("data-fill"));
      bar.style.width = `${Math.round(v*100)}%`;
    }
    root.appendChild(el);
  }
}

async function loadJsonFile(path){
  const res = await fetch(path, { cache: "no-store" });
  if(!res.ok){
    throw new Error(`${path} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ${res.status}ï¼‰ã€‚`);
  }
  return await res.json();
}

function safeJsonParse(text, label){
  try{
    return { ok:true, value: JSON.parse(text) };
  }catch(e){
    return { ok:false, error: `${label} ã®JSONãŒå£Šã‚Œã¦ã„ã¾ã™ã€‚${e.message || String(e)}` };
  }
}

function validateLex(obj){
  const keys = ["real","anon","empa","part"];
  for(const k of keys){
    if(!(k in obj)) return `lex.json ã« ${k} ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`;
    if(!Array.isArray(obj[k])) return `lex.json ã® ${k} ã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`;
    for(const item of obj[k]){
      if(!item || typeof item !== "object") return `lex.json ã® ${k} å†…ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãªã„è¦ç´ ãŒã‚ã‚Šã¾ã™ã€‚`;
      if(!Array.isArray(item.w)) return `lex.json ã® ${k} ã®å„è¦ç´ ã¯ w é…åˆ—ãŒå¿…è¦ã§ã™ã€‚`;
      if(typeof item.p !== "number") return `lex.json ã® ${k} ã®å„è¦ç´ ã¯ p æ•°å€¤ãŒå¿…è¦ã§ã™ã€‚`;
    }
  }
  return "";
}

function validatePlatforms(obj){
  if(!obj || typeof obj !== "object") return "platforms.json ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚";
  if(!obj.default) return "platforms.json ã« default ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
  return "";
}

function validateData(arr){
  if(!Array.isArray(arr)) return "data.json ã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚";
  for(let i=0;i<arr.length;i++){
    const p = arr[i];
    if(!p || typeof p !== "object") return `data.json ã® ${i} ç•ªç›®ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`;
    if(typeof p.text !== "string") return `data.json ã® ${i} ç•ªç›®ã« text æ–‡å­—åˆ—ãŒå¿…è¦ã§ã™ã€‚`;
  }
  return "";
}

function setLeftStatusOk(msg){
  $("leftStatus").innerHTML = `<span class="ok">${toSafeTextAsHtml(msg)}</span>`;
}

function setLeftStatusError(msg){
  $("leftStatus").innerHTML = `<span class="danger">${toSafeTextAsHtml(msg)}</span>`;
}

function analyzeFromObjects(dataObj, lexObj, platformsObj){
  const gain = Number($("gain").value) || 1.0;

  LEX = lexObj;
  PLATFORMS = platformsObj;

  const posts = (Array.isArray(dataObj) ? dataObj : [dataObj]).map(normalizePost);
  lastAnalyzed = posts.map(p => analyzePost(p, gain));

  $("btnExport").disabled = lastAnalyzed.length === 0;
  render(lastAnalyzed);
}

function analyzeFromTextareas(){
  $("summary").textContent = "å†è¨ˆç®—ä¸­ã€‚";
  $("btnExport").disabled = true;

  const pData = safeJsonParse($("taData").value, "data.json");
  if(!pData.ok){ setLeftStatusError(pData.error); $("summary").innerHTML = `<span class="danger">${toSafeTextAsHtml(pData.error)}</span>`; return; }

  const pLex = safeJsonParse($("taLex").value, "lex.json");
  if(!pLex.ok){ setLeftStatusError(pLex.error); $("summary").innerHTML = `<span class="danger">${toSafeTextAsHtml(pLex.error)}</span>`; return; }

  const pPlat = safeJsonParse($("taPlatforms").value, "platforms.json");
  if(!pPlat.ok){ setLeftStatusError(pPlat.error); $("summary").innerHTML = `<span class="danger">${toSafeTextAsHtml(pPlat.error)}</span>`; return; }

  const lexErr = validateLex(pLex.value);
  if(lexErr){ setLeftStatusError(lexErr); $("summary").innerHTML = `<span class="danger">${toSafeTextAsHtml(lexErr)}</span>`; return; }

  const platErr = validatePlatforms(pPlat.value);
  if(platErr){ setLeftStatusError(platErr); $("summary").innerHTML = `<span class="danger">${toSafeTextAsHtml(platErr)}</span>`; return; }

  const dataErr = validateData(pData.value);
  if(dataErr){ setLeftStatusError(dataErr); $("summary").innerHTML = `<span class="danger">${toSafeTextAsHtml(dataErr)}</span>`; return; }

  try{
    analyzeFromObjects(pData.value, pLex.value, pPlat.value);
    setLeftStatusOk("ãƒ•ã‚©ãƒ¼ãƒ ã®å†…å®¹ã§å†è¨ˆç®—ã—ã¾ã—ãŸã€‚");
  }catch(err){
    const msg = err.message || String(err);
    setLeftStatusError(msg);
    $("summary").innerHTML = `<span class="danger">${toSafeTextAsHtml(msg)}</span>`;
  }
}

async function loadAllToTextareas(){
  $("summary").textContent = "èª­ã¿è¾¼ã¿ä¸­ã€‚";
  $("btnExport").disabled = true;
  setLeftStatusOk("å¤–éƒ¨JSONã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚");

  try{
    const lex = await loadJsonFile("lex.json");
    const plats = await loadJsonFile("platforms.json");
    const data = await loadJsonFile("data.json");

    $("taLex").value = JSON.stringify(lex, null, 2);
    $("taPlatforms").value = JSON.stringify(plats, null, 2);
    $("taData").value = JSON.stringify(data, null, 2);

    setLeftStatusOk("å¤–éƒ¨JSONã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã—ã¾ã—ãŸã€‚");
    analyzeFromTextareas();
  }catch(err){
    const msg = err.message || String(err);
    setLeftStatusError(msg);
    $("summary").innerHTML = `<span class="danger">${toSafeTextAsHtml(msg)}</span>`;
    $("results").innerHTML = "";
    lastAnalyzed = [];
  }
}

function exportJson(){
  if(!lastAnalyzed.length) return;
  const blob = new Blob([JSON.stringify(lastAnalyzed, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "kaidan_4factor_result.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

$("btnReload").addEventListener("click", loadAllToTextareas);
$("btnRecalc").addEventListener("click", analyzeFromTextareas);
$("btnExport").addEventListener("click", exportJson);

$("sort").addEventListener("change", ()=> render(lastAnalyzed));
$("buzzTh").addEventListener("input", ()=> render(lastAnalyzed));
$("gain").addEventListener("change", ()=> analyzeFromTextareas());

loadAllToTextareas();
</script>
</body>
</html>
